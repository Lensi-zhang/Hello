<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>晚安问候</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
        }
        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: fadeIn 1s ease-out;
        }
        h1 {
            color: #333;
            font-size: 3rem;
            margin: 0;
            transition: all 0.5s ease;
        }
        p {
            color: #666;
            font-size: 1.2rem;
            margin-top: 15px;
            transition: all 0.5s ease;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.8s ease-out 0.3s forwards;
        }
        /* 统一的入场动画 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(15px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        /* 内容模块的延迟动画 */
        .content-module {
            opacity: 0;
            transform: translateY(15px);
            transition: all 0.6s ease;
        }
        /* 时间模块样式 */
        .time-container {
            margin-top: 20px;
            opacity: 0;
            transform: translateY(15px);
            animation: fadeInUp 0.8s ease-out 0.5s forwards;
        }
        .time-display {
            font-size: 1.5rem;
            color: #555;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .date-display {
            font-size: 1rem;
            color: #888;
            margin-top: 5px;
            transition: all 0.3s ease;
        }
        /* 天气模块样式 */
        .weather-container {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(15px);
            animation: fadeInUp 0.8s ease-out 0.7s forwards;
            transition: all 0.3s ease;
        }
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            h1 {
                font-size: 2rem;
            }
        }
        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .location {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }
        .refresh-btn:hover {
            background: #764ba2;
        }
        .weather-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        .weather-icon {
            font-size: 3rem;
        }
        .temperature {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
        }
        .weather-details {
            text-align: left;
        }
        .weather-desc {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 5px;
        }
        .humidity-wind {
            font-size: 0.9rem;
            color: #888;
        }
        .weather-loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>晚安</h1>
        <p>愿你有一个宁静美好的夜晚</p>
        
        <!-- 实时时间模块 -->
        <div class="time-container">
            <div class="time-display" id="time-display">--:--:--</div>
            <div class="date-display" id="date-display">----年--月--日</div>
        </div>
        
        <!-- 天气模块 -->
        <div class="weather-container">
            <div class="weather-header">
                <div class="location" id="location">北京</div>
                <button class="refresh-btn" onclick="getWeatherData()">刷新天气</button>
            </div>
            <div class="weather-info">
                <div class="weather-icon" id="weather-icon">☁️</div>
                <div class="temperature" id="temperature">22°C</div>
                <div class="weather-details">
                    <div class="weather-desc" id="weather-desc">多云</div>
                    <div class="humidity-wind" id="humidity-wind">湿度: 55% | 风速: 2.1 m/s</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 高德地图API Key
        const amapApiKey = 'cebd2ed5a03641dd6bbe701596a48da3';
        
        // 天气图标映射
        const weatherIcons = {
            '晴': '☀️',
            '多云': '☁️',
            '阴': '☁️',
            '小雨': '🌦️',
            '中雨': '🌧️',
            '大雨': '⛈️',
            '暴雨': '⛈️',
            '雷阵雨': '⛈️',
            '小雪': '❄️',
            '中雪': '❄️',
            '大雪': '❄️',
            '雾': '🌫️',
            '霾': '🌫️',
            'default': '☀️'
        };
        
        // 全局变量存储当前天气和位置数据
        let currentWeatherData = null;
        
        // 区域名称映射到代表城市
        const regionMap = {
            '华中地区': '武汉',
            '华北地区': '北京',
            '华东地区': '上海',
            '华南地区': '广州',
            '西北地区': '西安',
            '西南地区': '成都',
            '东北地区': '沈阳'
        };
        
        // 获取天气数据
        function getWeatherData() {
            // 显示加载状态
            updateLoadingState();
            
            // 直接使用IP定位获取位置
            getLocationByIP();
        }
        
        // 更新加载状态
        function updateLoadingState() {
            document.getElementById('temperature').textContent = '加载中...';
            document.getElementById('weather-desc').textContent = '获取天气信息中...';
            document.getElementById('humidity-wind').textContent = '';
        }
        
        // 使用IP地址获取位置信息（使用高德地图API）
        function getLocationByIP() {
            console.log('开始IP定位...');
            
            // 高德地图IP定位API
            const amapIpLocationUrl = `https://restapi.amap.com/v3/ip?key=${amapApiKey}`;
            
            // 使用JSONP方式调用API（避免CORS问题）
            const callbackName = 'amapIpCallback_' + Date.now();
            
            // 设置全局回调函数
            window[callbackName] = function(data) {
                console.log('IP定位结果:', data);
                
                // 处理返回的数据
                if (data.status === '1') {
                    let cityName = data.city || data.province;
                    console.log(`定位到: ${cityName}`);
                    
                    // 检查是否是区域名称，如果是则使用代表城市
                    if (regionMap[cityName]) {
                        console.log(`区域名称映射: ${cityName} -> ${regionMap[cityName]}`);
                        cityName = regionMap[cityName];
                    }
                    
                    // 根据城市名获取天气信息
                    getWeatherByCity(cityName);
                } else {
                    console.error('IP定位失败:', data.info);
                    // 这里不使用备用方案，只显示错误信息
                    document.getElementById('temperature').textContent = '定位失败';
                    document.getElementById('weather-desc').textContent = `错误: ${data.info || '未知错误'}`;
                }
                
                // 清理
                cleanupJsonpScript(callbackName);
            };
            
            // 创建并添加script标签
            createJsonpScript(`${amapIpLocationUrl}&output=jsonp&callback=${callbackName}`, callbackName);
        }
        
        // 创建JSONP script标签
        function createJsonpScript(url, callbackName) {
            const script = document.createElement('script');
            script.id = `jsonp-${callbackName}`;
            script.src = url;
            script.onerror = function() {
                console.error('JSONP请求失败');
                document.getElementById('temperature').textContent = '请求失败';
                document.getElementById('weather-desc').textContent = '无法连接到定位服务';
                cleanupJsonpScript(callbackName);
            };
            document.head.appendChild(script);
        }
        
        // 清理JSONP资源
        function cleanupJsonpScript(callbackName) {
            setTimeout(() => {
                const script = document.getElementById(`jsonp-${callbackName}`);
                if (script && script.parentNode) {
                    script.parentNode.removeChild(script);
                }
                delete window[callbackName];
            }, 0);
        }
        
        // 根据城市名称获取天气信息
        function getWeatherByCity(cityName) {
            console.log(`获取${cityName}的天气信息...`);
            
            // 首先需要通过地理编码获取城市经纬度
            const geocodeUrl = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(cityName)}&key=${amapApiKey}`;
            
            const geocodeCallbackName = 'amapGeocodeCallback_' + Date.now();
            
            window[geocodeCallbackName] = function(data) {
                console.log('地理编码结果:', data);
                
                if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                    // 提取经纬度
                    const location = data.geocodes[0].location;
                    const [lon, lat] = location.split(',').map(coord => parseFloat(coord));
                    console.log(`获取到${cityName}的经纬度: 纬度=${lat}, 经度=${lon}`);
                    
                    // 使用高德地图天气API获取天气信息
                    getAmapWeather(lat, lon, cityName);
                } else {
                    console.error('地理编码失败');
                    document.getElementById('temperature').textContent = '获取失败';
                    document.getElementById('weather-desc').textContent = '无法获取城市信息';
                }
                
                cleanupJsonpScript(geocodeCallbackName);
            };
            
            createJsonpScript(`${geocodeUrl}&output=jsonp&callback=${geocodeCallbackName}`, geocodeCallbackName);
        }
        
        // 获取高德地图天气信息
        function getAmapWeather(lat, lon, cityName) {
            // 高德地图天气API需要城市的adcode，这里使用经纬度逆地理编码获取adcode
            const regeoUrl = `https://restapi.amap.com/v3/geocode/regeo?location=${lon},${lat}&key=${amapApiKey}`;
            
            const regeoCallbackName = 'amapRegeoCallback_' + Date.now();
            
            window[regeoCallbackName] = function(data) {
                console.log('逆地理编码结果:', data);
                
                if (data.status === '1' && data.regeocode && data.regeocode.addressComponent) {
                    const adcode = data.regeocode.addressComponent.adcode;
                    
                    if (adcode) {
                        // 使用adcode获取天气信息
                        fetchWeatherWithAdcode(adcode, cityName);
                    } else {
                        // 如果没有获取到adcode，使用模拟天气数据
                        displayMockWeather(cityName);
                    }
                }
                
                cleanupJsonpScript(regeoCallbackName);
            };
            
            createJsonpScript(`${regeoUrl}&output=jsonp&callback=${regeoCallbackName}`, regeoCallbackName);
        }
        
        // 使用adcode获取天气信息
        function fetchWeatherWithAdcode(adcode, cityName) {
            const weatherUrl = `https://restapi.amap.com/v3/weather/weatherInfo?city=${adcode}&key=${amapApiKey}`;
            
            const weatherCallbackName = 'amapWeatherCallback_' + Date.now();
            
            window[weatherCallbackName] = function(data) {
                console.log('天气查询结果:', data);
                
                if (data.status === '1' && data.lives && data.lives.length > 0) {
                    const weatherData = data.lives[0];
                    
                    // 构建天气数据对象
                    const weatherInfo = {
                        city: cityName,
                        temperature: weatherData.temperature,
                        description: weatherData.weather,
                        humidity: weatherData.humidity,
                        windSpeed: weatherData.windpower,
                        weatherType: weatherData.weather
                    };
                    
                    // 更新天气显示
                    updateWeatherDisplay(weatherInfo);
                } else {
                    console.error('天气查询失败');
                    displayMockWeather(cityName);
                }
                
                cleanupJsonpScript(weatherCallbackName);
            };
            
            createJsonpScript(`${weatherUrl}&output=jsonp&callback=${weatherCallbackName}`, weatherCallbackName);
        }
        
        // 显示未知天气数据（当API调用失败时使用）
        function displayMockWeather(cityName) {
            console.log('数据获取失败，显示未知数据');
            
            const unknownData = {
                city: cityName || '未知位置',
                temperature: '--',
                description: '未知',
                humidity: '--',
                windSpeed: '--',
                weatherType: 'default'
            };
            
            updateWeatherDisplay(unknownData);
        }
        
        // 更新天气显示
        function updateWeatherDisplay(weatherData) {
            // 更新全局天气数据
            currentWeatherData = weatherData;
            
            const weatherContainer = document.querySelector('.weather-container');
            
            // 添加更新动画效果
            weatherContainer.style.transform = 'translateY(5px)';
            weatherContainer.style.opacity = '0.9';
            
            // 短暂延迟后更新内容
            setTimeout(() => {
                document.getElementById('location').textContent = weatherData.city;
                document.getElementById('temperature').textContent = weatherData.temperature + '°C';
                document.getElementById('weather-icon').textContent = weatherIcons[weatherData.weatherType] || weatherIcons.default;
                document.getElementById('weather-desc').textContent = weatherData.description;
                document.getElementById('humidity-wind').textContent = 
                    `湿度: ${weatherData.humidity}% | 风速: ${weatherData.windSpeed} 级`;
                
                // 恢复原始状态
                weatherContainer.style.transform = 'translateY(0)';
                weatherContainer.style.opacity = '1';
            }, 200);
            
            // 更新语录
            updateInspirationalQuote();
        }

        // 调用星火大数据API生成随机语录（流式响应）
        function updateInspirationalQuote() {
            if (!currentWeatherData) {
                console.log('天气数据未就绪，无法生成语录');
                return;
            }
            
            // 构建关键词参数
            const city = currentWeatherData.city || '未知位置';
            const weather = currentWeatherData.description || '未知天气';
            const temperature = currentWeatherData.temperature || '--';
            const hour = new Date().getHours();
            
            // 星火大数据API调用（使用HTTP POST流式响应）
            const apiKey = '2f3d88b9c7a5e52f05d2f36241db2d08'; // 用户提供的API密钥
            const appId = '56cc1a3a';   // 用户提供的应用ID
            const apiSecret = 'ODVhMmMyYmVlZTFkYjYwNzlkNWUxZTYz'; // 用户提供的API密钥
            const prompt = `生成一句简短优美的问候语或励志语录，包含以下元素：当前在${city}，天气${weather}，温度${temperature}°C，时间${hour}点左右。语录要简洁、温暖、有正能量。`;
            
            // 使用模拟数据生成励志语录
            async function callSparkAPI() {
                try {
                    // 由于跨域问题，直接使用模拟数据
                    console.log('使用模拟数据生成励志语录');
                    fallbackToSimulatedData();
                } catch (error) {
                    console.error('生成励志语录时出错:', error);
                    // 确保总是有数据显示
                    fallbackToSimulatedData();
                }
            }
            
            // 当代理服务不可用时的回退方案
            function fallbackToSimulatedData() {
                const greetings = [
                    `${city}的${hour}点，${weather}${temperature}°C，愿你心情如阳光般温暖！`,
                    `${weather}的${city}，${temperature}°C，${hour}点的时光最适合享受生活！`,
                    `在${city}${weather}的${hour}点，${temperature}°C的温度，祝你有个愉快的一天！`,
                    `${hour}点的${city}，${weather}宜人，${temperature}°C正舒适，一切都会好起来的！`,
                    `今天${city}${weather}，${temperature}°C，${hour}点的你，最美最棒！`
                ];
                
                const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
                const pElement = document.querySelector('p');
                
                // 添加平滑的过渡效果更新问候语
                pElement.style.opacity = '0';
                pElement.style.transform = 'translateY(5px)';
                
                setTimeout(() => {
                    pElement.textContent = randomGreeting;
                    pElement.style.opacity = '1';
                    pElement.style.transform = 'translateY(0)';
                }, 300);
                
                console.log('使用模拟数据作为回退方案');
            }
            
            // 调用代理API
            callSparkAPI();
            
            // 回退到默认问候语的函数
            function fallbackToDefaultGreeting() {
                const greetingInfo = getGreetingByTime(hour);
                document.querySelector('p').textContent = greetingInfo.subtitle;
            }
        }
        
        // 根据时间获取问候语
        function getGreetingByTime(hour) {
            if (hour >= 0 && hour < 6) {
                return { greeting: '夜深了', subtitle: '早点休息，做个好梦' };
            } else if (hour >= 6 && hour < 12) {
                return { greeting: '早上好', subtitle: '新的一天，充满活力' };
            } else if (hour >= 12 && hour < 14) {
                return { greeting: '中午好', subtitle: '午休时间，放松一下' };
            } else if (hour >= 14 && hour < 18) {
                return { greeting: '下午好', subtitle: '下午时光，继续加油' };
            } else if (hour >= 18 && hour < 22) {
                return { greeting: '晚上好', subtitle: '晚上愉快，享受休闲时光' };
            } else {
                return { greeting: '夜深了', subtitle: '早点休息，晚安' };
            }
        }

        // 更新时间显示 - 绑定到window对象确保在任何作用域都能访问
        window.updateTime = function() {
            const now = new Date();
            const hour = now.getHours();
            
            // 获取适合当前时间的问候语
            const greetingInfo = getGreetingByTime(hour);
            const h1Element = document.querySelector('h1');
            
            // 只有当问候语变化时才添加过渡动画
            if (h1Element.textContent !== greetingInfo.greeting) {
                h1Element.style.opacity = '0';
                h1Element.style.transform = 'translateY(-5px)';
                
                // 短暂延迟后更新内容并恢复显示
                setTimeout(() => {
                    h1Element.textContent = greetingInfo.greeting;
                    h1Element.style.opacity = '1';
                    h1Element.style.transform = 'translateY(0)';
                }, 200);
            }
            
            // 格式化时间
            const hours = hour.toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            
            // 格式化日期
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const dateString = `${year}年${month}月${day}日`;
            
            // 更新DOM
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            
            // 为时间更新添加平滑过渡
            timeDisplay.style.opacity = '0.7';
            setTimeout(() => {
                timeDisplay.textContent = timeString;
                timeDisplay.style.opacity = '1';
            }, 50);
            
            // 只有当日期变化时才更新日期显示
            if (dateDisplay.textContent !== dateString) {
                dateDisplay.style.opacity = '0';
                setTimeout(() => {
                    dateDisplay.textContent = dateString;
                    dateDisplay.style.opacity = '1';
                }, 200);
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            // 为了确保页面加载时有初始显示，先执行一次updateTime
            updateTime();
            // 设置定时器，每秒更新一次时间
            setInterval(updateTime, 1000);
            
            // 获取天气数据
            getWeatherData();
        };
    </script>
</body>
</html>